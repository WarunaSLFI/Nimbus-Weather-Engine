{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///F:/Github%20Projects/Nimbus-Weather-Engine/app/api/weather/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { WeatherApiResponse, UIWeather, UIDaily, UIHourly, UIDetails } from \"@/app/lib/types\";\r\n\r\n// Helper to fill missing days if API provides fewer than 7\r\n// (Free plan provides 3 days)\r\n// Helper to fill missing days if API provides fewer than 7\r\n// (Free plan provides 3 days)\r\nfunction fillMockDays(lastRealDay: UIDaily, totalNeeded: number): UIDaily[] {\r\n    const mockDays: UIDaily[] = [];\r\n    const baseDate = new Date(lastRealDay.date);\r\n\r\n    // Simple deterministic pseudo-random logic based on base temps\r\n    for (let i = 1; i <= totalNeeded; i++) {\r\n        const d = new Date(baseDate);\r\n        d.setDate(baseDate.getDate() + i);\r\n\r\n        const dateStr = d.toLocaleDateString(\"en-CA\"); // YYYY-MM-DD\r\n        const dayName = d.toLocaleDateString(\"en-GB\", { weekday: 'short' });\r\n\r\n        // Add some random variation\r\n        const variance = Math.floor(Math.sin(d.getDate()) * 5);\r\n        const varianceF = variance * 1.8;\r\n\r\n        mockDays.push({\r\n            date: dateStr,\r\n            dayName,\r\n            max_c: lastRealDay.max_c + variance,\r\n            max_f: Math.round(lastRealDay.max_f + varianceF),\r\n            min_c: lastRealDay.min_c + variance,\r\n            min_f: Math.round(lastRealDay.min_f + varianceF),\r\n            conditionText: i % 2 === 0 ? \"Partly Cloudy\" : \"Sunny\",\r\n            conditionIcon: i % 2 === 0 ? \"//cdn.weatherapi.com/weather/64x64/day/116.png\" : \"//cdn.weatherapi.com/weather/64x64/day/113.png\",\r\n            chance_of_rain: Math.abs(variance * 10),\r\n            isMock: true\r\n        });\r\n    }\r\n    return mockDays;\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n    const { searchParams } = new URL(request.url);\r\n    const query = searchParams.get(\"q\");\r\n\r\n    if (!query) {\r\n        return NextResponse.json({ error: \"Missing query parameter\" }, { status: 400 });\r\n    }\r\n\r\n    const apiKey = process.env.WEATHERAPI_KEY;\r\n    if (!apiKey) {\r\n        return NextResponse.json({ error: \"Server misconfigured\" }, { status: 500 });\r\n    }\r\n\r\n    try {\r\n        // 3 days is typical free limit, but we ask for 7 just in case using a paid key eventually\r\n        const url = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${encodeURIComponent(query)}&days=7&aqi=yes&alerts=no`;\r\n\r\n        const res = await fetch(url);\r\n\r\n        if (!res.ok) {\r\n            const errData = await res.json();\r\n            return NextResponse.json({ error: errData.error?.message || \"Weather API Error\" }, { status: res.status });\r\n        }\r\n\r\n        const data: WeatherApiResponse = await res.json();\r\n\r\n        // --- Normalize Data ---\r\n\r\n        // 1. Hourly (Next 10 hours from now)\r\n        const currentEpoch = data.location.localtime_epoch;\r\n        const allHours = data.forecast.forecastday.flatMap(d => d.hour);\r\n\r\n        // Filter hours > current hour, take next 10\r\n        const nextHoursRaw = allHours.filter(h => h.time_epoch >= currentEpoch).slice(0, 24);\r\n        const hourly: UIHourly[] = nextHoursRaw.slice(0, 12).map((h, idx) => ({\r\n            time: idx === 0 ? \"Now\" : new Date(h.time_epoch * 1000).toLocaleTimeString(\"en-US\", { hour: 'numeric', minute: '2-digit', hour12: true }),\r\n            temp_c: Math.round(h.temp_c),\r\n            temp_f: Math.round(h.temp_f),\r\n            conditionText: h.condition.text,\r\n            conditionIcon: h.condition.icon,\r\n            chance_of_rain: h.chance_of_rain,\r\n            isNow: idx === 0\r\n        }));\r\n\r\n        // 2. Daily (7 days ideally)\r\n        const realDays: UIDaily[] = data.forecast.forecastday.map(d => {\r\n            const dateObj = new Date(d.date);\r\n            return {\r\n                date: d.date,\r\n                dayName: dateObj.toLocaleDateString(\"en-GB\", { weekday: 'short' }),\r\n                max_c: Math.round(d.day.maxtemp_c),\r\n                max_f: Math.round(d.day.maxtemp_f),\r\n                min_c: Math.round(d.day.mintemp_c),\r\n                min_f: Math.round(d.day.mintemp_f),\r\n                conditionText: d.day.condition.text,\r\n                conditionIcon: d.day.condition.icon,\r\n                chance_of_rain: d.day.daily_chance_of_rain,\r\n                isMock: false\r\n            };\r\n        });\r\n\r\n        // Fill mocks if needed (up to 7)\r\n        let finalDaily = [...realDays];\r\n        if (finalDaily.length < 7) {\r\n            const needed = 7 - finalDaily.length;\r\n            const mocks = fillMockDays(finalDaily[finalDaily.length - 1], needed);\r\n            finalDaily = [...finalDaily, ...mocks];\r\n        } else {\r\n            finalDaily = finalDaily.slice(0, 7);\r\n        }\r\n\r\n        if (finalDaily.length > 0) finalDaily[0].dayName = \"Today\";\r\n\r\n\r\n        // 3. Details\r\n        const today = data.forecast.forecastday[0];\r\n        const currentHourData = today.hour.find(h => Math.abs(h.time_epoch - currentEpoch) < 3600) || today.hour[0];\r\n\r\n        const details: UIDetails = {\r\n            sunrise: today.astro.sunrise,\r\n            sunset: today.astro.sunset,\r\n            pressure_mb: data.current.pressure_mb,\r\n            visibility_km: data.current.vis_km,\r\n            uv: data.current.uv,\r\n            humidity: data.current.humidity,\r\n            wind_kph: data.current.wind_kph,\r\n            feelsLike_c: data.current.feelslike_c,\r\n            feelsLike_f: data.current.feelslike_f,\r\n            airQualityIndex: data.current.air_quality?.[\"us-epa-index\"]\r\n        };\r\n\r\n        const uiData: UIWeather = {\r\n            location: {\r\n                name: data.location.name,\r\n                region: data.location.region,\r\n                country: data.location.country,\r\n                lat: data.location.lat,\r\n                lon: data.location.lon,\r\n                localtime: data.location.localtime,\r\n                tz_id: data.location.tz_id\r\n            },\r\n            current: {\r\n                temp_c: Math.round(data.current.temp_c),\r\n                temp_f: Math.round(data.current.temp_f),\r\n                conditionText: data.current.condition.text,\r\n                conditionIcon: data.current.condition.icon,\r\n                feelslike_c: Math.round(data.current.feelslike_c),\r\n                feelslike_f: Math.round(data.current.feelslike_f),\r\n                humidity: data.current.humidity,\r\n                wind_kph: Math.round(data.current.wind_kph),\r\n                uv: data.current.uv\r\n            },\r\n            hourly,\r\n            daily: finalDaily,\r\n            details,\r\n            extraDetails: {\r\n                precip_mm: data.current.precip_mm,\r\n                cloud: data.current.cloud,\r\n                gust_kph: data.current.gust_kph,\r\n                moon_phase: today.astro.moon_phase,\r\n                moon_illumination: parseInt(today.astro.moon_illumination) || 0,\r\n                us_epa_index: data.current.air_quality?.[\"us-epa-index\"] || 0,\r\n                dewpoint_c: currentHourData.dewpoint_c,\r\n                dewpoint_f: currentHourData.dewpoint_f\r\n            }\r\n        };\r\n\r\n        return NextResponse.json(uiData);\r\n\r\n    } catch (error) {\r\n        console.error(\"Weather API Error:\", error);\r\n        return NextResponse.json({ error: \"Failed to fetch weather data\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}